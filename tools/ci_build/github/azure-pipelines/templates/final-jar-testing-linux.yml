# Run Java tests on CPU machines with the CPU java package

parameters:
- name: OS
  displayName: Operating System
  type: string

- name: PoolName
  type: string

- name: PoolDemands
  type: string
  default: ''

stages:
- stage: Final_Jar_Testing_${{parameters.OS}}
  dependsOn: []
  jobs:
  - job: Final_Jar_Testing_${{parameters.OS}}
    workspace:
      clean: all
    ${{ if eq(parameters.OS, 'MacOS') }}:
      pool:
        # Use PoolName if provided, otherwise fallback to macOS-15
        ${{ if ne(parameters.PoolName, '') }}:
          ${{ if contains(parameters.PoolName, '-') }}:
            vmImage: ${{ parameters.PoolName }}
          ${{ else }}:
            name: ${{ parameters.PoolName }}
            ${{ if ne(parameters.PoolDemands, '') }}:
              demands: ${{ parameters.PoolDemands }}
        ${{ else }}:
          vmImage: 'macOS-15'
    ${{ if eq(parameters.OS, 'Linux') }}:
      pool:
        name: ${{ parameters.PoolName }}
    variables:
    - name: runCodesignValidationInjection
      value: false
    timeoutInMinutes: 60
    steps:
    - template: set-version-number-variables-step.yml

    - bash: |
        echo "Downloading and installing Maven $(mavenVersion)..."
        MAVEN_DIR="$(Agent.TempDirectory)/apache-maven-$(mavenVersion)"

        # Download Maven binary
        if command -v wget &> /dev/null; then
            wget https://archive.apache.org/dist/maven/maven-3/$(mavenVersion)/binaries/apache-maven-$(mavenVersion)-bin.tar.gz -O $(Agent.TempDirectory)/maven.tar.gz
        else
            curl -L -o $(Agent.TempDirectory)/maven.tar.gz https://archive.apache.org/dist/maven/maven-3/$(mavenVersion)/binaries/apache-maven-$(mavenVersion)-bin.tar.gz
        fi

        # Extract to the temp directory
        mkdir -p ${MAVEN_DIR}
        tar -xzf $(Agent.TempDirectory)/maven.tar.gz -C $(Agent.TempDirectory)

        # Add Maven's bin directory to the PATH for subsequent tasks in the job
        echo "##vso[task.prependpath]${MAVEN_DIR}/bin"
      displayName: 'Install Maven'
      condition: and(succeeded(), in(variables['Agent.OS'], 'Linux', 'Darwin'))

    - script: |
        echo "Maven is now on the PATH."
        mvn --version

    - script: |
        set -e -x
        if ! /usr/libexec/java_home -v 17 >/dev/null 2>&1; then
          brew install --cask temurin@17
        fi
        JAVA_HOME=$(/usr/libexec/java_home -v 17)
        echo "JAVA_HOME is set to: $JAVA_HOME"
        echo "##vso[task.setvariable variable=JAVA_HOME]$JAVA_HOME"
        echo "##vso[task.prependpath]$JAVA_HOME/bin"
      displayName: 'Install JDK 17 (macOS)'
      condition: and(succeeded(), eq(variables['Agent.OS'], 'Darwin'))

    - download: build
      artifact: 'onnxruntime-java'
      displayName: 'Download Final Jar'

    - task: Maven@4
      displayName: 'Download Dependencies into App Folder'
      inputs:
        mavenPomFile: '$(Build.SourcesDirectory)/tools/ci_build/java/pom.xml'
        goals: 'dependency:copy-dependencies'
        options: '-DoutputDirectory=$(Pipeline.Workspace)/build/onnxruntime-java'
        publishJUnitTestResults: false
        mavenVersionOption: 'Default'
        ${{ if eq(parameters.OS, 'MacOS') }}:
          javaHomeOption: 'Path'
          jdkDirectory: '$(JAVA_HOME)'
        ${{ if eq(parameters.OS, 'Linux') }}:
          javaHomeOption: 'JDKVersion'
          jdkVersionOption: '1.17'

    - task: Bash@3
      displayName: 'Run Java Tests'
      condition: and(succeeded(), in(variables['Agent.OS'], 'Linux', 'Darwin'))
      inputs:
        targetType: 'inline'
        script: |
          set -e -x
          cd $(Pipeline.Workspace)/build/onnxruntime-java
          rm -f *.asc
          rm -f *.sha256
          rm -f *.sha512
          rm -f *.sha1
          rm -f *.md5
          rm -f *.pom
          ls
          cd ..
          mkdir tests
          cd tests
          # 1. Diagnostics
          echo "System Info:"
          uname -a
          if [[ "$(uname)" == "Darwin" ]]; then arch; fi
          echo "Java Version"
          java -version

          # 2. Extract
          jar xf $(Pipeline.Workspace)/build/onnxruntime-java/testing.jar
          rm -f $(Pipeline.Workspace)/build/onnxruntime-java/testing.jar

          # Identify main jar (avoiding sources and javadoc jars)
          MAIN_JAR=$(ls $(Pipeline.Workspace)/build/onnxruntime-java/onnxruntime-*.jar | grep -v 'sources' | grep -v 'javadoc' | head -n 1)
          echo "Extracting native libs from $MAIN_JAR"
          jar xf $MAIN_JAR ai/onnxruntime/native

          ls -R $(Pipeline.Workspace)/build/tests/ai
          echo "Java Version"
          java -version


          # 3. Find with robustness
          os_name=$(uname)
          if [[ "$os_name" == "Linux" ]]; then S_FILE="libonnxruntime.so"; else S_FILE="libonnxruntime.dylib"; fi

          echo "Searching for $S_FILE in $(pwd)..."
          # Exclude .dSYM paths and find actual file
          NATIVE_LIB_PATH=$(find $(pwd) -name "$S_FILE" -not -path "*.dSYM*" -type f | head -n 1)

          if [[ -n "$NATIVE_LIB_PATH" ]]; then
            NATIVE_LIB_DIR=$(dirname "$NATIVE_LIB_PATH")
            echo "Found native lib dir: $NATIVE_LIB_DIR"

            if [[ "$os_name" == "Linux" ]]; then
              echo "Platform: Linux. Setting LD_LIBRARY_PATH."
              export LD_LIBRARY_PATH="$NATIVE_LIB_DIR:$(pwd):$LD_LIBRARY_PATH"
              java -cp '$(Pipeline.Workspace)/build/tests:$(Pipeline.Workspace)/build/onnxruntime-java/*' org.junit.platform.console.ConsoleLauncher --scan-classpath=$(Pipeline.Workspace)/build/tests \
              --fail-if-no-tests --disable-banner --reports-dir "$(Build.ArtifactStagingDirectory)/TestResults"
            elif [[ "$os_name" == "Darwin" ]]; then
              echo "Platform: macOS. Setting DYLD_LIBRARY_PATH."
              export DYLD_LIBRARY_PATH="$NATIVE_LIB_DIR:$(pwd):$DYLD_LIBRARY_PATH"
              java -DUSE_WEBGPU=1 -DUSE_COREML=1 -cp '$(Pipeline.Workspace)/build/tests:$(Pipeline.Workspace)/build/onnxruntime-java/*' org.junit.platform.console.ConsoleLauncher --scan-classpath=$(Pipeline.Workspace)/build/tests \
              --fail-if-no-tests --disable-banner --reports-dir "$(Build.ArtifactStagingDirectory)/TestResults"
            fi
          else
            echo "Error: $S_FILE not found!"
            ls -R ai
            exit 1
          fi


    - task: PublishTestResults@2
      displayName: 'Publish Test Results'
      inputs:
        testResultsFormat: 'JUnit'
        testResultsFiles: '$(Build.ArtifactStagingDirectory)/TestResults/TEST-junit-jupiter.xml'
        failTaskOnFailedTests: true
